---
interface Props {
  tags: string[];
  allLabel?: string;
}

const { tags, allLabel = 'All' } = Astro.props;

const uniqueTags = [...new Set(tags)].sort();
---

<div class="project-filter">
  <button 
    class="filter-btn active" 
    data-filter="all"
    data-cursor-hover
  >
    {allLabel}
  </button>
  {uniqueTags.map((tag) => (
    <button 
      class="filter-btn" 
      data-filter={tag.toLowerCase().replace(/\s+/g, '-')}
      data-cursor-hover
    >
      {tag}
    </button>
  ))}
</div>

<style>
  .project-filter {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    justify-content: center;
    margin-bottom: 3rem;
  }

  .filter-btn {
    padding: 0.5rem 1.25rem;
    border: 1px solid var(--color-text-muted);
    border-radius: 100px;
    background: transparent;
    color: var(--color-text-muted);
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.25s ease;
    white-space: nowrap;
  }

  .filter-btn:hover {
    border-color: var(--color-accent);
    color: var(--color-accent);
  }

  .filter-btn:focus-visible {
    outline: 2px solid var(--color-accent);
    outline-offset: 2px;
  }

  .filter-btn.active {
    background: var(--color-accent);
    border-color: var(--color-accent);
    color: white;
  }

  @media (max-width: 600px) {
    .project-filter {
      gap: 0.5rem;
    }

    .filter-btn {
      padding: 0.4rem 1rem;
      font-size: 0.8rem;
    }
  }
</style>

<script is:inline>
  (function() {
    let filterController = null;

    function initProjectFilter() {
      // Abort previous listeners to prevent duplicates
      if (filterController) {
        filterController.abort();
      }
      filterController = new AbortController();
      const signal = filterController.signal;

      const filterBtns = document.querySelectorAll('.filter-btn');
      const filterableItems = document.querySelectorAll('[data-tags]');
      const allBtn = document.querySelector('.filter-btn[data-filter="all"]');

      // Debug: verify elements are found
      if (filterBtns.length === 0) {
        console.warn('[ProjectFilter] No filter buttons found');
        return;
      }

      // Helper to get active filters
      const getActiveFilters = function() {
        const activeBtns = document.querySelectorAll('.filter-btn.active:not([data-filter="all"])');
        return Array.from(activeBtns).map(function(btn) { return btn.dataset.filter; });
      };

      // Helper to get the wrapper element (ScrollReveal or direct parent)
      const getFilterWrapper = function(el) {
        const parent = el.parentElement;
        if (parent && parent.classList.contains('scroll-reveal')) {
          return parent;
        }
        return el;
      };

      // Helper to apply filters
      const applyFilters = function() {
        const activeFilters = getActiveFilters();
        const isAllActive = (allBtn && allBtn.classList.contains('active')) || activeFilters.length === 0;

        filterableItems.forEach(function(item) {
          const el = item;
          const wrapper = getFilterWrapper(el);
          const tagsAttr = el.dataset.tags || '';
          const tags = tagsAttr.toLowerCase().split(',').map(function(t) { 
            return t.trim().replace(/\s+/g, '-'); 
          });

          // Logic: Show if 'All' is active, OR if the item has AT LEAST ONE of the active filters
          const matches = isAllActive || activeFilters.some(function(filter) { 
            return tags.includes(filter || ''); 
          });

          if (matches) {
            if (wrapper.style.display === 'none') {
              wrapper.style.display = '';
              wrapper.classList.remove('filter-hidden');
              // Trigger re-animation on the wrapper
              wrapper.style.opacity = '0';
              wrapper.style.transform = 'translateY(20px)';
              requestAnimationFrame(function() {
                wrapper.style.transition = 'opacity 0.4s ease, transform 0.4s ease';
                wrapper.style.opacity = '1';
                wrapper.style.transform = 'none';
              });
            }
          } else {
            wrapper.style.display = 'none';
            wrapper.classList.add('filter-hidden');
          }
        });
      };

      filterBtns.forEach(function(btn) {
        btn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          
          const target = e.currentTarget;
          const filter = target.dataset.filter;

          if (filter === 'all') {
            // If 'All' clicked, clear others and activate 'All'
            filterBtns.forEach(function(b) { b.classList.remove('active'); });
            target.classList.add('active');
          } else {
            // Toggle clicked button
            target.classList.toggle('active');
            
            // Remove 'All' active state if any specific tag is selected
            if (target.classList.contains('active') && allBtn) {
              allBtn.classList.remove('active');
            }

            // If no specific tags are active, re-activate 'All'
            const currentActiveFilters = getActiveFilters();
            if (currentActiveFilters.length === 0 && allBtn) {
              allBtn.classList.add('active');
            }
          }

          applyFilters();
        }, { signal: signal });
      });
    }

    // Ensure DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initProjectFilter);
    } else {
      initProjectFilter();
    }
    document.addEventListener('astro:page-load', initProjectFilter);
  })();
</script>
